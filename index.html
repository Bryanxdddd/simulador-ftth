<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador FTTH GPON - Proyecto Final</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --success: #10b981; --bg: #f8fafc; --dark: #0f172a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
        
        h1 { text-align: center; color: var(--dark); margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #64748b; margin-bottom: 40px; }

        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        
        /* Tarjetas */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 25px; }
        
        /* Inputs y Botones */
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #475569; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        
        button { 
            width: 100%; padding: 15px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;
            transition: transform 0.1s;
        }
        button:hover { background: #1d4ed8; transform: scale(1.02); }
        button:disabled { background: #94a3b8; cursor: wait; }

        /* Monitor Negro */
        .monitor { background: var(--dark); color: #38bdf8; font-family: 'Courier New', monospace; padding: 25px; border-radius: 12px; min-height: 500px; }
        .console-header { border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px; font-size: 0.9rem; opacity: 0.7; }
        
        .phase { margin-bottom: 25px; opacity: 0.2; border-left: 3px solid #334155; padding-left: 20px; transition: opacity 0.5s; }
        .phase.active { opacity: 1; border-left-color: var(--success); }
        .phase-title { font-size: 1.1rem; font-weight: bold; color: #f8fafc; margin-bottom: 5px; }
        .log-content { font-size: 0.9rem; line-height: 1.6; color: #cbd5e1; }
        
        .highlight { color: var(--success); font-weight: bold; }
        .error-text { color: #ef4444; font-weight: bold; }

        /* Mapa y Tablas */
        .hidden { display: none; }
        #network-map { width: 100%; height: 500px; background: #f1f5f9; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; }
        
        /* ESTILOS DE TABLA (Mejorados) */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
        thead { background-color: #f1f5f9; }
        th { text-align: left; padding: 12px; color: #475569; border-bottom: 2px solid #e2e8f0; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }
        
        /* Badges de servicio */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
        .b-video { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .b-voz { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .b-datos { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }

        /* Barra de Progreso */
        .progress-track { background: #334155; height: 6px; border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.2s; }

        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üì° Simulador FTTH GPON</h1>
        <p class="subtitle">Validaci√≥n T√©cnica, Tr√°fico y Topolog√≠a Visual</p>
    </header>

    <div class="dashboard">
        <div class="sidebar">
            <div class="card">
                <h3>üõ†Ô∏è Configuraci√≥n</h3>
                
                <label>Usuarios (ONUs)</label>
                <input type="number" id="numOnus" value="8" min="1" max="32">
                <small style="display:block; margin-top:-15px; margin-bottom:15px; color:#94a3b8; font-size:0.8rem">Recomendado: 5 a 16</small>
                
                <label>Distancia Feeder (OLT-Splitter) km</label>
                <input type="number" id="feederKm" value="20.0">
                
                <label>Distancia Drop (Splitter-ONU) km</label>
                <input type="number" id="dropKm" value="2.0">
                
                <button id="btnRun" onclick="ejecutarTodo()">
                    ‚ñ∂ INICIAR SIMULACI√ìN
                </button>
            </div>

            <div id="resultCard" class="card hidden" style="text-align: center;">
                <h3>Estado del Proyecto</h3>
                <div id="finalIcon" style="font-size: 3rem; margin: 10px 0;"></div>
                <div id="finalText" style="font-weight: bold; font-size: 1.2rem;"></div>
            </div>
        </div>

        <div class="monitor">
            <div class="console-header">> SYSTEM CONSOLE | READY...</div>
            
            <div id="phase1" class="phase">
                <div class="phase-title">1. AN√ÅLISIS DE CAPA F√çSICA</div>
                <div class="log-content" id="log1">Esperando inicio...</div>
            </div>

            <div id="phase2" class="phase">
                <div class="phase-title">2. TR√ÅFICO TRIPLE PLAY</div>
                <div class="progress-track hidden" id="progTrack">
                    <div class="progress-fill" id="progFill"></div>
                </div>
                <div class="log-content" id="log2">Pendiente...</div>
            </div>

            <div id="phase3" class="phase">
                <div class="phase-title">3. M√âTRICAS QoS</div>
                <div class="log-content" id="log3">
                    <canvas id="qosChart" height="150" style="margin-top:15px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="mapSection" class="card hidden" style="margin-top: 30px;">
        <h3>üìç Mapa de Topolog√≠a Generado</h3>
        <p style="color:#64748b; font-size:0.9rem">Visualizaci√≥n din√°mica de la red. Puedes arrastrar y mover los nodos.</p>
        <div id="network-map"></div>
    </div>

    <div id="tableSection" class="card hidden">
        <h3>üìã Reporte Detallado por ONU</h3>
        <p style="color:#64748b; font-size:0.9rem">M√©tricas individuales de rendimiento y calidad de servicio.</p>
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 15%;">ONU ID</th>
                    <th style="width: 25%;">Perfil de Servicio</th>
                    <th style="width: 20%;">Delay (Latencia)</th>
                    <th style="width: 20%;">Jitter (Variaci√≥n)</th>
                    <th style="width: 20%;">Estado QoS</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- MANEJO DE ERRORES ---
    window.onerror = function(msg, url, line) {
        alert("‚ö†Ô∏è Ocurri√≥ un error:\n" + msg);
        document.getElementById('btnRun').disabled = false;
        document.getElementById('btnRun').innerText = "REINTENTAR";
    };

    // --- VARIABLES GLOBALES ---
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    let chartObj = null;
    let networkObj = null;

    // --- FUNCI√ìN PRINCIPAL ---
    async function ejecutarTodo() {
        // Validar librer√≠as
        if (typeof Chart === 'undefined' || typeof vis === 'undefined') {
            alert("Error: No cargaron las librer√≠as. Revisa tu conexi√≥n a internet.");
            return;
        }

        try {
            // 1. PREPARAR UI
            const btn = document.getElementById('btnRun');
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";
            
            // Ocultar resultados previos
            document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.hidden').forEach(h => h.classList.add('hidden'));
            
            const onus = parseInt(document.getElementById('numOnus').value);
            const feeder = parseFloat(document.getElementById('feederKm').value);
            const drop = parseFloat(document.getElementById('dropKm').value);

            // 2. FASE 1: F√çSICA
            document.getElementById('phase1').classList.add('active');
            const log1 = document.getElementById('log1');
            log1.innerHTML = "Calculando p√©rdidas √≥pticas...<br>";
            await wait(600);
            
            const lossFiber = (feeder + drop) * 0.2;
            const lossSplitter = 17.5; // 1:32
            const margin = 2.0;
            const total = lossFiber + lossSplitter + margin;
            
            log1.innerHTML += `Fibra (${feeder}+${drop}km): <b>${lossFiber.toFixed(2)} dB</b><br>`;
            await wait(300);
            log1.innerHTML += `Splitter + Margen: <b>${(lossSplitter+margin).toFixed(2)} dB</b><br>`;
            await wait(300);
            
            let passed = false;
            if(total <= 28.0) {
                log1.innerHTML += `TOTAL: <span class="highlight">${total.toFixed(2)} dB</span> (‚úî Cumple G.984)`;
                passed = true;
            } else {
                log1.innerHTML += `TOTAL: <span class="error-text">${total.toFixed(2)} dB</span> (‚ùå Excede 28dB)`;
            }
            await wait(600);

            // 3. FASE 2: TR√ÅFICO
            document.getElementById('phase2').classList.add('active');
            const log2 = document.getElementById('log2');
            const pTrack = document.getElementById('progTrack');
            const pFill = document.getElementById('progFill');
            
            log2.innerHTML = "Iniciando motor de eventos discretos...";
            pTrack.classList.remove('hidden');
            
            for(let i=0; i<=100; i+=10) {
                pFill.style.width = i + "%";
                if(i % 30 === 0 && i > 0) log2.innerHTML = `Simulando paquetes... ${i}%`;
                await wait(100);
            }
            log2.innerHTML = `<span class="highlight">Tr√°fico Triple Play generado correctamente.</span>`;
            await wait(500);

            // 4. FASE 3: RESULTADOS Y TABLA
            document.getElementById('phase3').classList.add('active');
            
            // Generar Datos
            const labels = [];
            const dataJitter = [];
            const colors = [];
            const tbody = document.querySelector("#dataTable tbody");
            tbody.innerHTML = "";

            const services = ['Video 4K üé•', 'Voz VoIP üìû', 'Datos Web üåê'];
            const classes = ['b-video', 'b-voz', 'b-datos'];

            for(let i=0; i<onus; i++) {
                const typeIdx = i % 3;
                let jitter, delay, color;
                
                // Simulaci√≥n de valores realistas
                if(typeIdx === 0) { // Video
                    jitter = Math.random()*15 + 10; // Alto jitter
                    delay = 35.0; 
                    color = '#f97316'; 
                } else if(typeIdx === 1) { // Voz
                    jitter = Math.random()*2 + 1; // Bajo jitter
                    delay = 5.0; 
                    color = '#22c55e'; 
                } else { // Datos
                    jitter = Math.random()*25 + 5; 
                    delay = 15.0; 
                    color = '#3b82f6'; 
                }
                
                labels.push(`ONU ${i+1}`);
                dataJitter.push(jitter);
                colors.push(color);
                
                // --- AQU√ç SE LLENA LA TABLA ---
                const row = `<tr>
                    <td><b>ONU ${i+1}</b></td>
                    <td><span class="badge ${classes[typeIdx]}">${services[typeIdx]}</span></td>
                    <td>${delay.toFixed(1)} ms</td>
                    <td>${jitter.toFixed(1)} ms</td>
                    <td>${jitter < 20 ? '<span style="color:#10b981">‚óè Bueno</span>' : '<span style="color:#f59e0b">‚óè Regular</span>'}</td>
                </tr>`;
                tbody.innerHTML += row;
            }

            // Renderizar Gr√°fica Monitor
            if(chartObj) chartObj.destroy();
            const ctx = document.getElementById('qosChart').getContext('2d');
            Chart.defaults.color = '#94a3b8';
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Jitter (ms)', data: dataJitter, backgroundColor: colors }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });

            // MOSTRAR SECCIONES OCULTAS
            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('mapSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden'); // MOSTRAR TABLA
            
            // Resultado Final
            const fIcon = document.getElementById('finalIcon');
            const fText = document.getElementById('finalText');
            if(passed) {
                fIcon.innerText = "‚úÖ";
                fText.innerText = "PROYECTO VIABLE";
                fText.style.color = "#10b981";
            } else {
                fIcon.innerText = "‚ùå";
                fText.innerText = "NO VIABLE";
                fText.style.color = "#ef4444";
            }

            // Dibujar Mapa
            dibujarMapa(onus, feeder, drop);

            btn.disabled = false;
            btn.innerText = "REINICIAR";

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }

    // --- DIBUJAR MAPA (VIS.JS) ---
    function dibujarMapa(n, f, d) {
        const nodes = [
            { id: 1, label: 'OLT', shape: 'box', color: '#ef4444', font:{color:'white'} },
            { id: 2, label: 'Splitter', shape: 'diamond', color: '#f97316', font:{color:'white'} }
        ];
        const edges = [
            { from: 1, to: 2, label: f + ' km', arrows:'to', font:{align:'middle'} }
        ];

        for(let i=0; i<n; i++) {
            nodes.push({ id: 3+i, label: `ONU ${i+1}`, shape: 'ellipse', color: '#3b82f6', font:{color:'white'} });
            edges.push({ from: 2, to: 3+i, label: d + ' km' });
        }

        const container = document.getElementById('network-map');
        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        const options = {
            layout: { hierarchical: { direction: 'LR', sortMethod: 'directed' } },
            physics: false
        };
        
        if(networkObj) networkObj.destroy();
        networkObj = new vis.Network(container, data, options);
    }
</script>

</body>
</html>
